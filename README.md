# Animation Streamer Example

ブラウザ上だけで「音声に合わせてモーションクリップを選択し、1 つのキャラクターが連続で喋っている動画」を生成するデモです。Cloudflare Pages にそのままデプロイできる React + Vite アプリとして構成しています。

## 仕組み

1. **音声解析**  
   - Web Audio API でアップロードされた音声を 80ms 窓の RMS に分解。  
   - ヒステリシス付きのしきい値で「発話 / 待機」セグメントを抽出し、開始時刻と長さを記録します。
2. **モーションクリップ管理**  
   - 待機・待機→発話・発話→発話(大)・発話→発話(小)・発話→待機の 5 カテゴリに分類された短尺動画を複数登録。  
   - 複数動画ファイルに加えて ZIP でまとめたアセットもドラッグ＆ドロップ一発で展開して登録可能。  
   - ブラウザで duration を自動取得し、フル尺のまま使用します。
3. **タイムライン生成**  
   - 発話セグメントの長さを満たすまで発話クリップを連結。できる限り発話→発話(大)で構成し、余った端数のみ発話→発話(小)で調整。足りない場合でも動画は削らず、余剰尺ぶん次の発話開始を遅延させます。  
   - 状態遷移に応じて待機→発話、発話→待機の遷移モーションを自動差し込み。
4. **レンダリング**  
   - `@ffmpeg/ffmpeg` (ffmpeg.wasm) を使用し、動画の concat と整列させた音声（無音パートを追加済み）を 1 本の MP4 に書き出します。

## 利用方法

```bash
npm install
npm run dev
```

ブラウザで `http://localhost:5173` を開き、以下の順に操作します。

1. 「音声準備」パネルでテキストから VOICEVOX / AIVIS Speech へ送るか、既存の音声ファイルをアップロードします。生成した音声は自動で解析にかけられ、必要なら「音声生成＆動画作成」でレンダリングまで一気通しできます。
2. 「モーションクリップ」パネルに並ぶ 5 種類（待機 / 待機→発話 / 発話→発話(大) / 発話→発話(小) / 発話→待機）のカードへ、それぞれ該当する動画をドロップまたはクリックで追加します。複数動画だけでなく ZIP まとめアップロードにも対応しています。
3. 追加済み素材はカード内のリストと下部テーブルに表示されるため、種類変更や削除もそこで行えます。
4. タイムライン構成が自動計算され、問題なければ「動画を書き出す」で ffmpeg.wasm による MP4 生成＆ダウンロードが行えます。

### 音声準備パネル（VOICEVOX / AIVIS Speech / アップロード）

- **テキストから生成（VOICEVOX / AIVIS Speech）**  
  - パネル上部の「テキストから生成」を選び、VOICEVOX 互換 API（VOICEVOX / AIVIS Speech など）の URL・話者 ID・テキストを入力するだけで OK です。  
  - VOICEVOX エンジンを起動し `http://localhost:50021` を指定すると `/audio_query` → `/synthesis` の順に呼び出し、得られた WAV を解析へ渡します。  
  - AIVIS Speech も VOICEVOX 互換 API として扱うため、同じ入力で利用できます（CORS 許可は各自の環境に合わせて設定してください）。
- **音声ファイルをアップロード**  
  - モードを「音声ファイルをアップロード」に切り替えると、WAV/MP3 などをドラッグ＆ドロップできます。

どの方法でも、生成/アップロードした音声はローカル保存を経ずにそのまま解析へ流し込まれます。

## Cloudflare Pages へのデプロイ

```bash
npm run build
# dist/ 以下を Cloudflare Pages のビルド成果物としてアップロード
```
